# @package _global_
# MDLM Baseline - Uniform Random Masking
# Standard masked diffusion without importance weighting (baseline for ATAT)

defaults:
  - /noise: loglinear
  - /strategy: ddp
  - /data: openwebtext
  - /callbacks: [checkpoint_every_n_steps, learning_rate_monitor]
  - _self_

# Basic settings
mode: train
diffusion: absorbing_state
backbone: dit
parameterization: subs
time_conditioning: False
T: 0
subs_masking: False
seed: 42

# Model configuration - SAME AS ATAT for fair comparison
model:
  name: "mdlm_uniform"
  type: "dit"
  vocab_size: 50257
  hidden_size: 768
  cond_dim: 128
  num_layers: 12
  num_heads: 12
  n_blocks: 12
  n_heads: 12
  length: 1024
  scale_by_sigma: True
  dropout: 0.1
  temb_strategy: adaln
  tie_word_embeddings: False
  
  # KEY DIFFERENCE: NO importance estimation or adaptive masking
  # This is standard MDLM with uniform random masking
  use_importance: False
  importance_mode: "uniform"  # Always uniform
  masking_strategy: "uniform"  # No adaptive masking

# Data configuration
data:
  train: openwebtext
  valid: wikitext103
  tokenizer_name_or_path: gpt2
  cache_dir: /media/scratch/adele/mdlm_fresh/data_cache
  wrap: True
  streaming: False

# Loader settings
loader:
  batch_size: 8  # Per GPU
  eval_batch_size: 4  # Per GPU for validation
  global_batch_size: 512  # 8 * 2 GPUs * 32 accumulation
  eval_global_batch_size: 8  # 4 * 2 GPUs
  num_workers: 4
  persistent_workers: true
  pin_memory: true

# Training settings - UNIFORM MASKING (standard MDLM)
training:
  ema: 0.9999
  antithetic_sampling: True
  importance_sampling: False  # NO importance sampling
  sampling_eps: 1e-3
  change_of_variables: False
  importance_loss_weight: 0.0  # NO importance loss

# Sampling settings
sampling:
  predictor: ddpm_cache
  steps: 128
  noise_removal: True
  num_sample_batches: 2
  num_sample_log: 2
  semi_ar: False
  stride_length: 1
  num_strides: 1

# Evaluation settings
eval:
  checkpoint_path: ''
  disable_ema: False
  compute_generative_perplexity: False
  perplexity_batch_size: 8
  compute_perplexity_on_sanity: False
  gen_ppl_eval_model_name_or_path: gpt2-large
  generate_samples: True

# NO curriculum (standard MDLM trains without curriculum)
curriculum:
  curriculum_type: "none"
  warmup_steps: 0
  easy_fraction: 0.0
  hard_fraction: 0.0
  dynamic_adjustment: false

# Trainer settings
trainer:
  num_nodes: 1
  devices: 2  # Number of GPUs
  accumulate_grad_batches: 32  # Effective batch = 8 * 2 * 32 = 512
  max_steps: 500000
  val_check_interval: 5000
  gradient_clip_val: 1.0
  precision: "16-mixed"
  log_every_n_steps: 50

# Optimizer - SAME AS ATAT
optim:
  name: adamw
  lr: 3.0e-4
  weight_decay: 0.01
  betas: [0.9, 0.999]
  eps: 1.0e-8

# LR Scheduler - SAME AS ATAT
lr_scheduler:
  name: cosine_decay_warmup
  warmup_steps: 10000
  eta_min: 1.0e-5

# Logging
wandb:
  project: "mdlm-baselines"
  name: "mdlm-uniform-baseline"
  tags: ["baseline", "mdlm", "uniform", "phase2"]
  notes: "MDLM baseline with uniform random masking (no importance weighting)"
  mode: "offline"

# Checkpointing
checkpointing:
  save_dir: /media/scratch/adele/mdlm_fresh/outputs/baselines/mdlm_uniform
  resume_from_ckpt: false
  resume_ckpt_path: ${.save_dir}/checkpoints/last.ckpt

checkpoint:
  dirpath: "/media/scratch/adele/mdlm_fresh/outputs/baselines/mdlm_uniform"
  filename: "mdlm-uniform-{step:06d}-{val_loss:.4f}"
  monitor: "val_loss"
  mode: "min"
  save_top_k: 3
  every_n_train_steps: 10000
  save_last: true
