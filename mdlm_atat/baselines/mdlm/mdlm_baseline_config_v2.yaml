# MDLM Baseline - Uniform Random Masking
# Standard MDLM without importance sampling (baseline for ATAT)
# Follows mdlm/configs/config.yaml structure exactly

defaults:
  - /callbacks: [checkpoint_every_n_steps, checkpoint_monitor, learning_rate_monitor]
  - /data: openwebtext
  - /model: small
  - /strategy: ddp
  - /noise: loglinear
  - /lr_scheduler: constant_warmup

mode: train
diffusion: absorbing_state
backbone: dit
parameterization: subs
time_conditioning: False
T: 0
subs_masking: False
seed: 1

loader:
  global_batch_size: 512
  eval_global_batch_size: ${.global_batch_size}
  batch_size: ${div_up:${.global_batch_size}, ${eval:${trainer.devices} * ${trainer.num_nodes}}}
  eval_batch_size: ${div_up:${.eval_global_batch_size}, ${eval:${trainer.devices} * ${trainer.num_nodes}}}
  num_workers: ${eval:"len(__import__('os').sched_getaffinity(0))"}
  pin_memory: True

sampling:
  predictor: ddpm_cache
  steps: 128
  noise_removal: True
  num_sample_batches: 2
  num_sample_log: 2
  semi_ar: False
  stride_length: 1
  num_strides: 1

training:
  ema: 0.9999
  antithetic_sampling: True
  importance_sampling: False  # KEY: Uniform random masking only
  sampling_eps: 1e-3
  change_of_variables: False

eval:
  checkpoint_path: ''
  disable_ema: False
  compute_generative_perplexity: True
  perplexity_batch_size: 8
  compute_perplexity_on_sanity: False
  gen_ppl_eval_model_name_or_path: gpt2-large
  generate_samples: True

optim:
  weight_decay: 0.01
  lr: 3.0e-4
  beta1: 0.9
  beta2: 0.999

trainer:
  accelerator: gpu
  devices: 2
  num_nodes: 1
  precision: 16-mixed
  max_steps: 500000
  accumulate_grad_batches: 32
  gradient_clip_val: 1.0
  log_every_n_steps: 100
  val_check_interval: 10000
  limit_val_batches: 56
  enable_checkpointing: True

checkpointing:
  save_dir: /media/scratch/adele/mdlm_fresh/outputs/baselines/mdlm_uniform
  every_n_train_steps: 10000
  monitor: val/loss
  mode: min
  save_top_k: 3
  save_last: True

wandb:
  project: mdlm-atat-baselines
  name: mdlm_uniform_baseline
  mode: online
  log_model: False
  tags:
    - baseline
    - mdlm
    - uniform_masking
  notes: "MDLM with uniform random masking - baseline for ATAT comparison"
