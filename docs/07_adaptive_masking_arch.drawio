<mxfile host="65bd71144e">
    <diagram id="adaptive-masking" name="Adaptive Masking Architecture">
        <mxGraphModel dx="1600" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1200">
            <root>
                <mxCell id="0"/>
                <mxCell id="1" parent="0"/>
                <mxCell id="2" value="Adaptive Masking Scheduler: Importance-Weighted Token Masking" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=22;fontStyle=1" vertex="1" parent="1">
                    <mxGeometry x="150" y="20" width="1100" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="3" value="Inputs" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=14;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="40" y="80" width="1320" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="4" value="Importance Scores&#xa;Shape: (B, L)&#xa;Range: [0, 1]&#xa;From ImportanceEstimator&#xa;Per-token difficulty" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11" vertex="1" parent="1">
                    <mxGeometry x="60" y="120" width="200" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="5" value="Timestep t&#xa;Shape: (B,) or scalar&#xa;Current diffusion step&#xa;Range: [0, T]&#xa;T = 1000" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11" vertex="1" parent="1">
                    <mxGeometry x="280" y="120" width="200" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="6" value="Curriculum Stage&#xa;One of: {easy, medium, hard}&#xa;From CurriculumScheduler&#xa;Determines τ temperature" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11" vertex="1" parent="1">
                    <mxGeometry x="500" y="120" width="220" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="7" value="Noise Schedule&#xa;Function: noise_rate(t)&#xa;Cosine/Linear schedule&#xa;Controls base mask rate" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11" vertex="1" parent="1">
                    <mxGeometry x="740" y="120" width="200" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="8" value="Position Bias (optional)&#xa;Shape: (L,)&#xa;Higher near boundaries&#xa;Bias certain positions" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11" vertex="1" parent="1">
                    <mxGeometry x="960" y="120" width="200" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="9" value="Min/Max Clipping&#xa;min_mask_prob = 0.0&#xa;max_mask_prob = 0.95&#xa;Safety bounds" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11" vertex="1" parent="1">
                    <mxGeometry x="1180" y="120" width="160" height="80" as="geometry"/>
                </mxCell>
                <mxCell id="10" value="Stage 1: Temperature Selection" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="40" y="260" width="620" height="200" as="geometry"/>
                </mxCell>
                <mxCell id="11" value="Get Temperature τ&#xa;Based on curriculum stage:&#xa;&#xa;if stage == 'easy':&#xa;    τ = 2.0  # High temp = more uniform&#xa;elif stage == 'medium':&#xa;    τ = 1.0  # Medium temp = balanced&#xa;elif stage == 'hard':&#xa;    τ = 0.5  # Low temp = sharper peaks&#xa;&#xa;Temperature controls distribution sharpness:&#xa;  High τ → flatter distribution → more uniform masking&#xa;  Low τ → sharper peaks → focus on high-importance" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="60" y="300" width="580" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="12" value="Temperature Annealing (Optional)&#xa;Linear schedule:&#xa;  τ(t) = τ_start + (τ_end - τ_start) * (t / T)&#xa;  τ_start = 2.0, τ_end = 0.5&#xa;&#xa;Allows smooth transition during training" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="700" y="260" width="660" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="13" value="Stage 2: Importance Weighting" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="40" y="480" width="1320" height="200" as="geometry"/>
                </mxCell>
                <mxCell id="14" value="Softmax with Temperature&#xa;&#xa;weight = softmax(importance / τ, dim=-1)&#xa;&#xa;Mathematical form:&#xa;  w_i = exp(s_i / τ) / Σ_j exp(s_j / τ)&#xa;&#xa;where:&#xa;  s_i = importance score for token i&#xa;  τ = temperature&#xa;  w_i = normalized weight [0, 1]&#xa;  Σ w_i = 1.0 (normalized)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left" vertex="1" parent="1">
                    <mxGeometry x="60" y="520" width="400" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="15" value="Example Values:&#xa;&#xa;importance = [0.2, 0.5, 0.8, 0.3]&#xa;&#xa;τ=2.0 (easy):&#xa;  weight ≈ [0.23, 0.26, 0.29, 0.24]  (uniform)&#xa;&#xa;τ=1.0 (medium):&#xa;  weight ≈ [0.19, 0.26, 0.35, 0.20]  (moderate)&#xa;&#xa;τ=0.5 (hard):&#xa;  weight ≈ [0.10, 0.23, 0.52, 0.15]  (sharp)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;align=left;fontFamily=Courier New;" vertex="1" parent="1">
                    <mxGeometry x="480" y="520" width="420" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="16" value="Visualization:&#xa;&#xa;High τ (2.0): ____▃▃▃▃____&#xa;                (flat)&#xa;&#xa;Med τ (1.0):  __▃▅▅▅▃__&#xa;               (moderate)&#xa;&#xa;Low τ (0.5):  _▂▅██▅▂_&#xa;               (sharp peaks)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;align=left;fontFamily=Courier New;" vertex="1" parent="1">
                    <mxGeometry x="920" y="520" width="420" height="140" as="geometry"/>
                </mxCell>
                <mxCell id="17" value="Stage 3: Noise Schedule Integration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="40" y="700" width="1320" height="180" as="geometry"/>
                </mxCell>
                <mxCell id="18" value="Compute Base Noise Rate&#xa;&#xa;Cosine Schedule:&#xa;  α_bar(t) = cos²(π * t / (2 * T))&#xa;  noise_rate(t) = 1 - α_bar(t)&#xa;&#xa;Properties:&#xa;  t=0: noise_rate ≈ 0 (no masking)&#xa;  t=T: noise_rate ≈ 1 (full masking)&#xa;  Smooth transition" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="60" y="740" width="400" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="19" value="Combine with Importance Weights&#xa;&#xa;base_prob = noise_rate(t)&#xa;importance_weight = softmax(importance / τ)&#xa;&#xa;mask_prob = base_prob * importance_weight&#xa;&#xa;Interpretation:&#xa;  Early steps (small t): low base_prob → less masking&#xa;  Late steps (large t): high base_prob → more masking&#xa;  Importance weights modulate within timestep" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="480" y="740" width="420" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="20" value="Renormalization&#xa;&#xa;Ensure probabilities sum correctly:&#xa;  mask_prob = mask_prob / mask_prob.sum()&#xa;  mask_prob = mask_prob * target_mask_ratio&#xa;&#xa;where target_mask_ratio from noise schedule&#xa;&#xa;Maintains correct total masking rate" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="920" y="740" width="420" height="120" as="geometry"/>
                </mxCell>
                <mxCell id="21" value="Stage 4: Position Bias (Optional)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="700" y="370" width="660" height="90" as="geometry"/>
                </mxCell>
                <mxCell id="22" value="Apply Position-Dependent Bias&#xa;&#xa;if use_position_bias:&#xa;    pos_bias = compute_position_bias(L)  # Shape: (L,)&#xa;    mask_prob = mask_prob * pos_bias&#xa;&#xa;Example: Higher masking near sequence start/end&#xa;  pos_bias[0:10] = 1.2  (boost early tokens)&#xa;  pos_bias[-10:] = 1.2  (boost late tokens)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="720" y="410" width="620" height="40" as="geometry"/>
                </mxCell>
                <mxCell id="23" value="Stage 5: Clipping &amp; Sampling" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="40" y="900" width="1320" height="160" as="geometry"/>
                </mxCell>
                <mxCell id="24" value="Clip Probabilities&#xa;&#xa;mask_prob = torch.clamp(&#xa;    mask_prob,&#xa;    min=min_mask_prob,  # 0.0&#xa;    max=max_mask_prob   # 0.95&#xa;)&#xa;&#xa;Prevents extreme values:&#xa;  - Never 100% certain to mask&#xa;  - Never 0% chance to mask" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="60" y="940" width="400" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="25" value="Bernoulli Sampling&#xa;&#xa;masks = torch.bernoulli(mask_prob)&#xa;&#xa;For each token:&#xa;  Sample ~ Bernoulli(p = mask_prob_i)&#xa;  mask_i = 1 w.p. p, 0 w.p. 1-p&#xa;&#xa;Output: Binary mask (B, L)&#xa;  1 = mask this token&#xa;  0 = keep this token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;align=left;fontStyle=1" vertex="1" parent="1">
                    <mxGeometry x="480" y="940" width="420" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="26" value="Deterministic Option&#xa;&#xa;if deterministic:&#xa;    # Top-k masking&#xa;    k = int(mask_prob.sum())&#xa;    _, indices = torch.topk(mask_prob, k)&#xa;    masks = torch.zeros_like(mask_prob)&#xa;    masks.scatter_(1, indices, 1)&#xa;&#xa;Masks exactly k highest-probability tokens" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="920" y="940" width="420" height="100" as="geometry"/>
                </mxCell>
                <mxCell id="27" value="Output" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=14;fontStyle=1" vertex="1" parent="1">
                    <mxGeometry x="400" y="1080" width="600" height="30" as="geometry"/>
                </mxCell>
                <mxCell id="28" value="Binary Masks&#xa;Shape: (B, L)&#xa;Values: {0, 1}&#xa;1 = mask (replace with [MASK] token)&#xa;0 = keep (preserve original token)&#xa;&#xa;Statistically:&#xa;  E[masks_i] = mask_prob_i&#xa;  Var[masks_i] = mask_prob_i * (1 - mask_prob_i)&#xa;&#xa;Integration:&#xa;  masked_tokens = original_tokens * (1 - masks) + MASK_ID * masks" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=left" vertex="1" parent="1">
                    <mxGeometry x="450" y="1120" width="500" height="160" as="geometry"/>
                </mxCell>
                <mxCell id="29" value="Masking Strategies" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="40" y="1300" width="440" height="180" as="geometry"/>
                </mxCell>
                <mxCell id="30" value="1. Uniform (Baseline)&#xa;   mask_prob = constant for all tokens&#xa;   No importance weighting&#xa;&#xa;2. Importance-Weighted (ATAT)&#xa;   mask_prob ∝ importance scores&#xa;   Focus on difficult tokens&#xa;&#xa;3. Inverse Importance&#xa;   mask_prob ∝ (1 - importance)&#xa;   Focus on easy tokens first&#xa;&#xa;4. Hybrid&#xa;   Switch strategy based on training progress" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="60" y="1340" width="400" height="130" as="geometry"/>
                </mxCell>
                <mxCell id="31" value="Curriculum Integration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="500" y="1300" width="440" height="180" as="geometry"/>
                </mxCell>
                <mxCell id="32" value="Easy Stage (0-33% of training):&#xa;  τ = 2.0, focus on importance &lt; 0.4&#xa;  Mask high-frequency, simple tokens&#xa;  Build basic language understanding&#xa;&#xa;Medium Stage (33-66% of training):&#xa;  τ = 1.0, focus on 0.3 &lt; importance &lt; 0.7&#xa;  Balanced masking across difficulty&#xa;  Refine predictions&#xa;&#xa;Hard Stage (66-100% of training):&#xa;  τ = 0.5, focus on importance &gt; 0.6&#xa;  Mask low-frequency, complex tokens&#xa;  Master difficult patterns" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="520" y="1340" width="400" height="130" as="geometry"/>
                </mxCell>
                <mxCell id="33" value="Performance Impact" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;fontStyle=1;verticalAlign=top" vertex="1" parent="1">
                    <mxGeometry x="960" y="1300" width="400" height="180" as="geometry"/>
                </mxCell>
                <mxCell id="34" value="Benefits:&#xa;  • 20% faster convergence&#xa;  • Better token difficulty modeling&#xa;  • Improved rare token handling&#xa;  • Curriculum learning synergy&#xa;&#xa;Computational Cost:&#xa;  • +5% overhead (softmax computation)&#xa;  • Negligible memory increase&#xa;  • Per-batch computation: O(B*L)&#xa;&#xa;Hyperparameters to Tune:&#xa;  • Temperature values (τ)&#xa;  • Min/max mask probabilities&#xa;  • Position bias weights (if used)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;fontSize=10;align=left" vertex="1" parent="1">
                    <mxGeometry x="980" y="1340" width="360" height="130" as="geometry"/>
                </mxCell>
            </root>
        </mxGraphModel>
    </diagram>
</mxfile>
